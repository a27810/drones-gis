{% extends "base.html" %}
{% load static %}

{% block title %}Editar ruta de vuelo ‚Äì Drones GIS{% endblock %}

{% block extra_css %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  >
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
  >

  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .page-subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid transparent;
      text-decoration: none;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
    }

    .btn-primary {
      background: #10b981;
      border-color: #10b981;
      color: #020617;
      font-weight: 500;
    }

    .btn-secondary {
      border-color: #374151;
    }

    .btn-outline {
      background: transparent;
      border-color: #4b5563;
    }

    .btn-danger {
      background: #b91c1c;
      border-color: #b91c1c;
      color: #f9fafb;
    }

    .btn:hover {
      filter: brightness(1.05);
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr);
      gap: 1.2rem;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .map-card,
    .info-card {
      background: #020617;
      border-radius: 18px;
      border: 1px solid #111827;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      padding: 1rem 1.2rem;
    }

    #map {
      width: 100%;
      height: 70vh;
      min-height: 420px;
      border-radius: 1.1rem;
      overflow: hidden;
    }

    .info-card h3 {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .info-card ul {
      font-size: 0.8rem;
      color: #9ca3af;
      padding-left: 1.1rem;
    }

    .form-footer {
      margin-top: 1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
  </style>
{% endblock %}

{% block content %}
<section>
  <div class="page-header">
    <div>
      <h1 class="page-title">Editar ruta de vuelo</h1>
      <p class="page-subtitle">
        Vuelo: <strong>{{ flight.name }}</strong>
        {% if flight.date %} ¬∑ {{ flight.date }}{% endif %}
      </p>
    </div>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
      <a href="{% url 'flight_list' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver a vuelos</a>
      <a href="{% url 'map' %}?flight={{ flight.id }}" class="btn btn-outline">üó∫Ô∏è Ver en mapa 2D</a>
    </div>
  </div>

  <!-- Formulario cl√°sico: POST con CSRF + campo oculto para el GeoJSON -->
  <form id="flight-path-form" method="post">
    {% csrf_token %}
    <input type="hidden" name="path_geojson" id="id_path_geojson">

    <div class="layout-grid">
      <div class="map-card">
        <div id="map"></div>
      </div>

      <aside class="info-card">
        <h3>Instrucciones</h3>
        <ul>
          <li>Dibuja la ruta usando la herramienta de l√≠nea de Leaflet Draw.</li>
          <li>Solo se guardar√° la <strong>√∫ltima l√≠nea</strong> que dejes creada.</li>
          <li>Pulsa <strong>‚ÄúGuardar ruta‚Äù</strong> para almacenar la geometr√≠a en la base de datos.</li>
          <li>Si env√≠as el formulario sin ninguna l√≠nea, el vuelo quedar√° <strong>sin ruta</strong>.</li>
        </ul>

        <div class="form-footer">
          <a href="{% url 'flight_list' %}" class="btn btn-outline">
            Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            üíæ Guardar ruta
          </button>
        </div>
      </aside>
    </div>
  </form>
</section>
{% endblock %}

{% block extra_js %}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    // GeoJSON inicial que nos pasa la vista (puede ser null)
    const initialGeoJSON = {{ initial_geojson|safe }};

    // Mapa base
    const map = L.map('map').setView([40.4167, -3.7033], 6); // Madrid por defecto

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Capa donde guardaremos la l√≠nea dibujada
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Si ya hab√≠a una ruta guardada, la pintamos
    if (initialGeoJSON && initialGeoJSON.type) {
      let geom = initialGeoJSON;

      // Si viene como Feature, usamos geometry
      if (geom.type === 'Feature' && geom.geometry) {
        geom = geom.geometry;
      }

      try {
        const layer = L.geoJSON(geom).addTo(drawnItems);
        const bounds = layer.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.2));
        }
      } catch (e) {
        console.error('Error al cargar la ruta existente:', e);
      }
    }

    // Controles de dibujo (solo polil√≠nea)
    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        edit: true,
        remove: true
      },
      draw: {
        marker: false,
        circle: false,
        circlemarker: false,
        polygon: false,
        rectangle: false,
        polyline: {
          shapeOptions: {
            color: '#22c55e',
            weight: 4
          }
        }
      }
    });
    map.addControl(drawControl);

    // Cada vez que se crea una nueva l√≠nea, eliminamos las anteriores
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
    });

    // Enviar el GeoJSON al backend al mandar el formulario
    const form = document.getElementById('flight-path-form');
    const inputGeoJSON = document.getElementById('id_path_geojson');

    form.addEventListener('submit', function (event) {
      // Cogemos la capa actual
      const fc = drawnItems.toGeoJSON();

      if (!fc.features.length) {
        // No hay geometr√≠a: dejamos path_geojson vac√≠o => se borra la ruta
        inputGeoJSON.value = "";
        return;
      }

      // Buscamos la primera LineString
      let lineGeom = null;
      for (const feat of fc.features) {
        if (feat.geometry && feat.geometry.type === 'LineString') {
          lineGeom = feat.geometry;
          break;
        }
      }

      if (!lineGeom) {
        alert('No se ha encontrado ninguna l√≠nea en el mapa.');
        event.preventDefault();
        return;
      }

      // Guardamos SOLO la geometry LineString como JSON
      inputGeoJSON.value = JSON.stringify(lineGeom);
    });
  </script>
{% endblock %}
