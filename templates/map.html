<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Visor de mapa – Drones GIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  >

  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #111827;
      color: #e5e7eb;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    header .left {
      display: flex;
      flex-direction: column;
    }
    header .title {
      font-size: 1rem;
      font-weight: 600;
    }
    header .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    header .right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    a.btn-link {
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      color: #e5e7eb;
      font-size: 0.8rem;
      background: transparent;
    }
    a.btn-primary {
      background: #10b981;
      border-color: #10b981;
      color: #111827;
    }
    select#flight-select {
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      max-width: 220px;
    }
    #map {
      height: calc(100vh - 52px);
      width: 100%;
    }

    /* Controles personalizados */
    .leaflet-control.custom-control {
      background: #111827;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .leaflet-control.custom-control button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      margin-right: 4px;
      font-size: 0.75rem;
      background: #10b981;
      color: #111827;
    }
    .leaflet-control.custom-control button.secondary {
      background: #374151;
      color: #e5e7eb;
    }
    .leaflet-control.custom-control span {
      display: inline-block;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="title">Visor GIS de vuelos y fotografías de drones</div>
      <div class="subtitle">Capas, rutas, fotos geolocalizadas y medición de distancias</div>
    </div>
    <div class="right">
      <label for="flight-select" style="font-size:0.8rem;">Vuelo:</label>
      <select id="flight-select">
        <option value="">Todos los vuelos</option>
      </select>
      <a href="{% url 'home' %}" class="btn-link">Inicio</a>
      <a href="{% url 'photo_list' %}" class="btn-link">Galería</a>
      <a href="{% url 'map3d_view' %}" class="btn-link">Mapa 3D</a>
      <a href="#" id="btn-export-geojson" class="btn-link">Exportar GeoJSON</a>
      <a href="{% url 'upload_photo' %}" class="btn-link btn-primary">+ Subir foto</a>
    </div>
  </header>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <!-- Leaflet.heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // --- Parámetros de la URL ---
    const params = new URLSearchParams(window.location.search);
    const photoIdParam  = parseInt(params.get('photo'), 10);
    const flightIdParam = parseInt(params.get('flight'), 10);

    const focusPhotoId  = Number.isInteger(photoIdParam)  ? photoIdParam  : null;
    const focusFlightId = Number.isInteger(flightIdParam) ? flightIdParam : null;

    // --- Crear mapa ---
    const map = L.map('map').setView([40.4167, -3.7033], 6); // Madrid

    const osmBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Capas base (por si luego añades más) ---
    const baseLayers = {
      "OpenStreetMap": osmBase
    };

    // --- Grupos de capas ---
    const photoLayer   = L.layerGroup().addTo(map);
    const flightsLayer = L.layerGroup().addTo(map);
    const zonesLayer   = L.layerGroup().addTo(map);
    const measureLayer = L.layerGroup().addTo(map);

    // Heatmap
    const heatLayer = L.heatLayer([], {
      radius: 25,
      blur: 15,
      maxZoom: 17
    }).addTo(map);

    const bounds = L.latLngBounds([]);
    let focusMarker = null;
    let animatedMarker = null;
    let animationIntervalId = null;

    function extendBoundsLatLon(lat, lon) {
      try { bounds.extend([lat, lon]); } catch (e) {}
    }

    // Icono de fotos
    const photoIcon = L.icon({
      iconUrl: '/static/img/camera-marker.png',
      iconSize:     [28, 28],
      iconAnchor:   [14, 28],
      popupAnchor:  [0, -24]
    });

    const flightSelect = document.getElementById('flight-select');

    // --- Convierte LineString GeoJSON a array de [lat,lng] ---
    function lineStringToLatLngs(path_geojson) {
      let line = null;
      if (!path_geojson) return [];

      if (path_geojson.type === 'LineString') {
        line = path_geojson;
      } else if (path_geojson.type === 'Feature' &&
                 path_geojson.geometry &&
                 path_geojson.geometry.type === 'LineString') {
        line = path_geojson.geometry;
      }

      if (!line || !Array.isArray(line.coordinates)) return [];

      return line.coordinates.map(function(coord) {
        // GeoJSON: [lon, lat]
        return [coord[1], coord[0]];
      });
    }

    // --- Animación del dron ---
    function stopAnimation() {
      if (animationIntervalId !== null) {
        clearInterval(animationIntervalId);
        animationIntervalId = null;
      }
      if (animatedMarker) {
        map.removeLayer(animatedMarker);
        animatedMarker = null;
      }
    }

    function startFlightAnimation(latlngs) {
      stopAnimation();
      if (!latlngs || latlngs.length < 2) return;

      animatedMarker = L.circleMarker(latlngs[0], {
        radius: 6,
        color: '#fbbf24',
        fillColor: '#f59e0b',
        fillOpacity: 1
      }).addTo(map);

      let idx = 0;
      animationIntervalId = setInterval(function() {
        idx = (idx + 1) % latlngs.length;
        animatedMarker.setLatLng(latlngs[idx]);
      }, 700);
    }

    // --- Control de capas (ahora sí) ---
    const overlays = {
      'Fotos': photoLayer,
      'Vuelos': flightsLayer,
      'Zonas (BD proyecto)': zonesLayer,
      'Mapa de calor (fotos)': heatLayer
      // Más abajo añadiremos "Zonas UAS ENAIRE (local)" cuando carguemos el GeoJSON
    };

    const layersControl = L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);


    // --- Regla de distancia ---
    let measureMode = false;
    let measurePoints = [];
    let measurePolyline = null;

    function formatDistance(meters) {
      if (meters < 1000) {
        return meters.toFixed(1) + ' m';
      }
      return (meters / 1000).toFixed(2) + ' km';
    }

    function computeTotalDistance(points) {
      if (points.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < points.length; i++) {
        total += map.distance(points[i - 1], points[i]);
      }
      return total;
    }

    const measureControl = L.control({ position: 'topleft' });
    measureControl.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'leaflet-control custom-control');
      div.innerHTML = `
        <div>
          <button id="btn-measure">Regla</button>
          <button id="btn-measure-clear" class="secondary">Limpiar</button>
        </div>
        <span id="measure-info">Distancia: 0 m</span>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    measureControl.addTo(map);

    const btnMeasure      = document.getElementById('btn-measure');
    const btnMeasureClear = document.getElementById('btn-measure-clear');
    const measureInfo     = document.getElementById('measure-info');

    btnMeasure.addEventListener('click', function() {
      measureMode = !measureMode;
      btnMeasure.textContent = measureMode ? 'Midiendo…' : 'Regla';
      btnMeasure.style.backgroundColor = measureMode ? '#fbbf24' : '#10b981';
    });

    btnMeasureClear.addEventListener('click', function() {
      measureMode = false;
      btnMeasure.textContent = 'Regla';
      btnMeasure.style.backgroundColor = '#10b981';
      measurePoints = [];
      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
        measurePolyline = null;
      }
      measureInfo.textContent = 'Distancia: 0 m';
    });

    map.on('click', function(e) {
      if (!measureMode) return;
      measurePoints.push(e.latlng);

      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
      }
      measurePolyline = L.polyline(measurePoints, {
        color: '#f97316',
        weight: 3,
        dashArray: '4,4'
      }).addTo(measureLayer);

      const d = computeTotalDistance(measurePoints);
      measureInfo.textContent = 'Distancia: ' + formatDistance(d);
    });

    // --- Cargar datos de la API propia (fotos, vuelos, zonas BD) ---
    Promise.all([
      fetch('/api/photos/').then(r => r.json()),
      fetch('/api/flights/').then(r => r.json()),
      fetch('/api/zones/').then(r => r.json())
    ]).then(([photos, flights, zones]) => {
      // 1) Selector de vuelos
      if (flightSelect) {
        flights.sort((a, b) => {
          if (a.date && b.date && a.date !== b.date) {
            return a.date < b.date ? 1 : -1;
          }
          return a.id - b.id;
        });

        flights.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.id;
          const dateText = f.date ? ` (${f.date})` : '';
          opt.textContent = `${f.name}${dateText}`;
          if (focusFlightId !== null && f.id === focusFlightId) {
            opt.selected = true;
          }
          flightSelect.appendChild(opt);
        });

        flightSelect.addEventListener('change', () => {
          const value = flightSelect.value;
          if (value === '') {
            window.location.href = '/map/';
          } else {
            window.location.href = '/map/?flight=' + encodeURIComponent(value);
          }
        });
      }

      // 2) Filtrar fotos por vuelo si viene en la URL
      let photosToShow = photos;
      if (focusFlightId !== null) {
        photosToShow = photos.filter(p => p.flight === focusFlightId);
      }

      const heatPoints = [];

      // 3) Pintar fotos y heatmap
      photosToShow.forEach(p => {
        const lat = parseFloat(p.lat);
        const lon = parseFloat(p.lon);
        if (!isNaN(lat) && !isNaN(lon)) {
          const marker = L.marker([lat, lon], { icon: photoIcon }).addTo(photoLayer);
          const img   = p.image ? `<img src="${p.image}" style="max-width:220px;display:block;margin:6px 0">` : '';
          const notes = p.notes || '';
          marker.bindPopup(`<b>Foto #${p.id}</b><br>${img}<small>${notes}</small>`);

          extendBoundsLatLon(lat, lon);

          if (focusPhotoId !== null && p.id === focusPhotoId) {
            focusMarker = marker;
          }

          heatPoints.push([lat, lon, 0.8]);
        }
      });

      if (heatPoints.length > 0) {
        heatLayer.setLatLngs(heatPoints);
      }

      // 4) Pintar zonas (modelo Zone de tu BD)
      zones.forEach(z => {
        if (!z.geometry) return;

        const styleFn = function(feature) {
          const t = (z.zone_type || '').toLowerCase();
          let color = '#10b981'; // verde por defecto
          if (t.includes('prohib')) {
            color = '#ef4444';
          } else if (t.includes('restr')) {
            color = '#f97316';
          }
          return {
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.15
          };
        };

        const layer = L.geoJSON(z.geometry, {
          style: styleFn
        }).addTo(zonesLayer);

        layer.bindPopup(`<b>${z.name}</b><br><small>${z.zone_type}</small>`);

        try {
          const zb = layer.getBounds();
          if (zb.isValid()) {
            bounds.extend(zb);
          }
        } catch (e) {}
      });

      // 5) Pintar vuelos (rutas)
      const palette = [
        '#2563eb', '#16a34a', '#db2777',
        '#f97316', '#7c3aed', '#059669'
      ];

      let focusedFlightLatLngs = null;

      flights.forEach((f, idx) => {
        if (!f.path_geojson) return;
        const latlngs = lineStringToLatLngs(f.path_geojson);
        if (!latlngs.length) return;

        const color = palette[idx % palette.length];
        const isFocused = (focusFlightId !== null && f.id === focusFlightId);

        const line = L.polyline(latlngs, {
          color: color,
          weight: isFocused ? 5 : 3,
          opacity: isFocused ? 0.9 : 0.6
        }).addTo(flightsLayer);

        line.bindPopup(`<b>${f.name}</b><br><small>Modelo: ${f.drone_model || '—'}</small>`);

        try {
          const lb = line.getBounds();
          if (lb.isValid()) {
            bounds.extend(lb);
          }
        } catch (e) {}

        if (isFocused) {
          focusedFlightLatLngs = latlngs;
        }
      });

      // 6) Ajustar vista y animación
      if (focusMarker) {
        const ll = focusMarker.getLatLng();
        map.setView(ll, 15);
        focusMarker.openPopup();
      } else if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      }

      if (focusedFlightLatLngs) {
        startFlightAnimation(focusedFlightLatLngs);
      } else {
        stopAnimation();
      }

    }).catch(err => {
      console.error('Error cargando datos GIS', err);
    });

    // --- Cargar Zonas UAS desde un GeoJSON local (sustituye a ENAIRE directo) ---
    fetch('/static/geojson/enaire_uas_zones_example.geojson')
      .then(r => {
        if (!r.ok) {
          console.warn('No se ha encontrado el GeoJSON local de zonas UAS ENAIRE.');
          return null;
        }
        return r.json();
      })
      .then(data => {
        if (!data) return;

        const enaireLayer = L.geoJSON(data, {
          style: function(feature) {
            const t = (feature.properties && (feature.properties.class || feature.properties.type || '')).toLowerCase();
            let color = '#1d4ed8';
            if (t.includes('prohib')) {
              color = '#b91c1c';
            } else if (t.includes('restr') || t.includes('ctr')) {
              color = '#ea580c';
            }
            return {
              color: color,
              weight: 2,
              fillColor: color,
              fillOpacity: 0.08
            };
          },
          onEachFeature: function(feature, layer) {
            const props = feature.properties || {};
            const name = props.name || props.NOMBRE || 'Zona UAS';
            const cls  = props.class || props.tipo || '';
            layer.bindPopup(`<b>${name}</b><br><small>${cls}</small>`);
          }
        });

        // añadimos la capa al mapa y al control de capas existente
        enaireLayer.addTo(map);
        overlays['Zonas UAS ENAIRE (local)'] = enaireLayer;
        layersControl.addOverlay(enaireLayer, 'Zonas UAS ENAIRE (local)');
      })
      .catch(err => {
        console.warn('Error cargando zonas UAS locales:', err);
      });


    // --- Botón Exportar GeoJSON de fotos ---
    const exportBtn = document.getElementById('btn-export-geojson');
    if (exportBtn) {
      exportBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const params = new URLSearchParams(window.location.search);
        const flightParam = params.get('flight');
        let url = '{% url "export_photos_geojson" %}';
        if (flightParam) {
          url += '?flight=' + encodeURIComponent(flightParam);
        }
        window.location.href = url;
      });
    }
  </script>
</body>
</html>
