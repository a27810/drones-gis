<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Drone Map MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>#map{height:100vh;margin:0;}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([40.4167, -3.7033], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    Promise.all([
      fetch('/api/photos/').then(r=>r.json()),
      fetch('/api/flights/').then(r=>r.json()),
      fetch('/api/zones/').then(r=>r.json()),
    ]).then(([photos, flights, zones])=>{
      // Fotos -> marcadores
      photos.forEach(p=>{
        const m=L.marker([p.lat,p.lon]).addTo(map);
        const img=p.image?`<img src="${p.image}" style="max-width:220px;display:block;margin:6px 0">`:'';
        m.bindPopup(`<b>Foto #${p.id}</b><br>${img}<small>${p.notes||''}</small>`);
      });

      // Vuelos -> polilÃ­neas (LineString GeoJSON lon,lat -> Leaflet lat,lon)
      flights.forEach(f=>{
        const g=f.path_geojson;
        if(g && g.type==='LineString'){
          const coords=g.coordinates.map(([lon,lat])=>[lat,lon]);
          L.polyline(coords).addTo(map).bindPopup(`<b>${f.name}</b><br>${f.drone_model||''}`);
        }
      });

      // Zonas -> Polygon/MultiPolygon
      const drawGeom=(z,geom)=>{
        if(geom.type==='Polygon'){
          const ring=geom.coordinates[0].map(([lon,lat])=>[lat,lon]);
          L.polygon(ring).addTo(map).bindPopup(`<b>${z.name}</b> (${z.zone_type})`);
        }else if(geom.type==='MultiPolygon'){
          geom.coordinates.forEach(poly=>{
            const ring=poly[0].map(([lon,lat])=>[lat,lon]);
            L.polygon(ring).addTo(map).bindPopup(`<b>${z.name}</b> (${z.zone_type})`);
          });
        }else if(geom.type==='LineString'){
          const coords=geom.coordinates.map(([lon,lat])=>[lat,lon]);
          L.polyline(coords).addTo(map).bindPopup(`<b>${z.name}</b> (${z.zone_type})`);
        }
      };
      zones.forEach(z=>{
        const g=z.geometry;
        if(!g) return;
        if(g.type==='Feature') drawGeom(z,g.geometry);
        else if(g.type==='FeatureCollection') g.features.forEach(ft=>drawGeom(z,ft.geometry));
        else drawGeom(z,g);
      });
    });
  </script>
</body>
</html>
