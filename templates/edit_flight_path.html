{% extends "base.html" %}

{% block title %}Editar ruta de vuelo ‚Äì Drones GIS{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
>
<!-- Leaflet.draw CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
/>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .page-title {
    font-size: 1.4rem;
    font-weight: 600;
  }

  .page-subtitle {
    font-size: 0.9rem;
    color: #9ca3af;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.85rem;
    border-radius: 999px;
    font-size: 0.85rem;
    border: 1px solid transparent;
    text-decoration: none;
    cursor: pointer;
    background: #020617;
    color: #e5e7eb;
  }

  .btn-primary {
    background: #10b981;
    border-color: #10b981;
    color: #020617;
    font-weight: 500;
  }

  .btn-secondary {
    border-color: #374151;
  }

  .btn-outline {
    background: transparent;
    border-color: #4b5563;
  }

  .btn-danger {
    background: #b91c1c;
    border-color: #b91c1c;
    color: #f9fafb;
  }

  .btn:hover {
    filter: brightness(1.05);
  }

  .editor-card {
    background: #020617;
    border-radius: 18px;
    border: 1px solid #111827;
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    padding: 1.2rem 1.4rem;
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
  }

  .route-map {
    width: 100%;
    height: 430px;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid #111827;
  }

  .helper-text {
    font-size: 0.8rem;
    color: #9ca3af;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .helper-text span {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .editor-footer {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<section>
  <div class="page-header">
    <div>
      <h1 class="page-title">
        Editar ruta de vuelo ‚Äì {{ flight.name }} (#{{ flight.id }})
      </h1>
      <p class="page-subtitle">
        Dibuja o ajusta la trayectoria del dron sobre el mapa. La ruta se guardar√° como GeoJSON.
      </p>
    </div>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
      <a href="{% url 'flight_list' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver a vuelos</a>
      <a href="{% url 'map' %}?flight={{ flight.id }}" class="btn btn-outline">üó∫Ô∏è Ver vuelo en el mapa</a>
    </div>
  </div>

  <div class="editor-card">
    <div id="map-route" class="route-map"></div>

    <div class="helper-text">
      <span>‚úèÔ∏è Usa la herramienta de <strong>polil√≠nea</strong> (icono de l√≠nea) para dibujar el recorrido.</span>
      <span>üß© Puedes <strong>editar</strong> o <strong>borrar</strong> la ruta con los controles de edici√≥n.</span>
      <span>üíæ Cuando est√©s conforme, pulsa <strong>‚ÄúGuardar ruta‚Äù</strong> para almacenar el GeoJSON.</span>
    </div>

    <form id="route-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="path_geojson" id="id_path_geojson">

      <div class="editor-footer">
        <a href="{% url 'flight_list' %}" class="btn btn-outline">
          Cancelar
        </a>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button type="button" id="btn-clear-route" class="btn btn-secondary">
            üßπ Limpiar ruta
          </button>
          <button type="button" id="btn-save-route" class="btn btn-primary">
            üíæ Guardar ruta
          </button>
        </div>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<!-- Leaflet.draw JS -->
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
  (function() {
    const flightId = {{ flight.id }};
    const map = L.map('map-route').setView([40.4167, -3.7033], 6); // Centro aproximado Espa√±a

    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Capa donde se almacenar√° la ruta
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Controles de dibujo (solo polil√≠nea)
    const drawControl = new L.Control.Draw({
      position: 'topleft',
      draw: {
        polygon: false,
        rectangle: false,
        circle: false,
        circlemarker: false,
        marker: false,
        polyline: {
          shapeOptions: {
            color: '#22c55e',
            weight: 4
          }
        }
      },
      edit: {
        featureGroup: drawnItems,
        remove: true
      }
    });
    map.addControl(drawControl);

    // Solo queremos UNA ruta: si dibuja una nueva, eliminamos la anterior
    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      drawnItems.clearLayers();
      drawnItems.addLayer(layer);
      fitToDrawn();
    });

    map.on(L.Draw.Event.EDITED, function () {
      fitToDrawn();
    });

    map.on(L.Draw.Event.DELETED, function () {
      fitToDrawn();
    });

    function fitToDrawn() {
      const layers = drawnItems.getLayers();
      if (layers.length === 0) return;
      try {
        const bounds = layers[0].getBounds();
        if (bounds && bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      } catch (e) {
        // Si no tiene getBounds (raro), ignoramos
      }
    }

    // Cargar ruta existente desde la API (si la hay)
    fetch(`/api/flights/${flightId}/`)
      .then(r => {
        if (!r.ok) throw new Error('No se pudo cargar el vuelo');
        return r.json();
      })
      .then(data => {
        if (data && data.path_geojson) {
          try {
            const geojsonLayer = L.geoJSON(data.path_geojson);
            let lineLayer = null;

            geojsonLayer.eachLayer(function (l) {
              if (l instanceof L.Polyline) {
                lineLayer = l;
              }
            });

            if (lineLayer) {
              drawnItems.clearLayers();
              drawnItems.addLayer(lineLayer);
              fitToDrawn();
            }
          } catch (e) {
            console.error('Error interpretando path_geojson', e);
          }
        }
      })
      .catch(err => {
        console.error('Error cargando datos del vuelo', err);
      });

    // Botones
    const btnSave = document.getElementById('btn-save-route');
    const btnClear = document.getElementById('btn-clear-route');
    const hiddenInput = document.getElementById('id_path_geojson');
    const form = document.getElementById('route-form');

    btnClear.addEventListener('click', function() {
      if (!confirm('Esto eliminar√° la ruta actual dibujada. ¬øSeguro?')) {
        return;
      }
      drawnItems.clearLayers();
      hiddenInput.value = '';
    });

    btnSave.addEventListener('click', function() {
      const layers = drawnItems.getLayers();

      if (layers.length === 0) {
        if (!confirm('No hay ninguna ruta dibujada. Se eliminar√° la ruta existente (si la hab√≠a). ¬øQuieres continuar?')) {
          return;
        }
        hiddenInput.value = '';
      } else {
        const layer = layers[0];
        const geojson = layer.toGeoJSON();
        hiddenInput.value = JSON.stringify(geojson);
      }

      form.submit();
    });
  })();
</script>
{% endblock %}
