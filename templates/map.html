<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Visor de mapa ‚Äì Drones GIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS desde CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  >
  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #111827;
      color: #e5e7eb;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    header .left {
      display: flex;
      flex-direction: column;
    }
    header .title {
      font-size: 1rem;
      font-weight: 600;
    }
    header .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    header .right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    a.btn-link {
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      color: #e5e7eb;
      font-size: 0.8rem;
      background: transparent;
    }
    a.btn-primary {
      background: #10b981;
      border-color: #10b981;
      color: #111827;
    }
    select#flight-select {
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      max-width: 220px;
    }
    #map {
      height: calc(100vh - 52px); /* toda la pantalla menos el header */
      width: 100%;
    }

    /* Estilos para controles personalizados (regla de distancia) */
    .leaflet-control.custom-control {
      background: #111827;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .leaflet-control.custom-control button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      margin-right: 4px;
      font-size: 0.75rem;
      background: #10b981;
      color: #111827;
    }
    .leaflet-control.custom-control button.secondary {
      background: #374151;
      color: #e5e7eb;
    }
    .leaflet-control.custom-control span {
      display: inline-block;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="title">Visor GIS de vuelos y fotograf√≠as de drones</div>
      <div class="subtitle">Capas, rutas, fotos geolocalizadas y medici√≥n de distancias</div>
    </div>
    <div class="right">
      <label for="flight-select" style="font-size:0.8rem;">Vuelo:</label>
      <select id="flight-select">
        <option value="">Todos los vuelos</option>
      </select>
      <a href="{% url 'home' %}" class="btn-link">Inicio</a>
      <a href="{% url 'photo_list' %}" class="btn-link">Galer√≠a</a>
            <a href="{% url 'map3d_view' %}" class="btn-link">Mapa 3D</a>
      <a href="{% url 'upload_photo' %}" class="btn-link btn-primary">+ Subir foto</a>

    </div>
  </header>

  <div id="map"></div>

  <!-- Leaflet JS desde CDN -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>
  <script>
    // --- Leer par√°metros de la URL ---
    const params = new URLSearchParams(window.location.search);
    const photoIdParam = parseInt(params.get('photo'), 10);
    const flightIdParam = parseInt(params.get('flight'), 10);

    const focusPhotoId = Number.isInteger(photoIdParam) ? photoIdParam : null;
    const focusFlightId = Number.isInteger(flightIdParam) ? flightIdParam : null;

    // --- Crear mapa ---
    const map = L.map('map').setView([40.4167, -3.7033], 6); // Centro en Madrid por defecto

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Grupos de capas ---
    const photoLayer   = L.layerGroup().addTo(map);
    const flightsLayer = L.layerGroup().addTo(map);
    const zonesLayer   = L.layerGroup().addTo(map);
    const measureLayer = L.layerGroup().addTo(map); // para la regla de distancia

    const bounds = L.latLngBounds([]);
    let focusMarker = null;
    let animatedMarker = null;
    let animationIntervalId = null;

    function extendBoundsLatLon(lat, lon) {
      try { bounds.extend([lat, lon]); } catch (e) {}
    }

    // --- Icono personalizado para fotos ---
    // Crea por ejemplo un archivo static/img/camera-marker.png y apunta aqu√≠.
    const photoIcon = L.icon({
      iconUrl: '/static/img/camera-marker.png',
      iconSize:     [28, 28],
      iconAnchor:   [14, 28],
      popupAnchor:  [0, -24]
    });

    // --- Icono para el dron animado sobre la ruta ---
    const droneIcon = L.icon({
      iconUrl: '/static/img/camera-marker.png',
      iconSize:     [32, 32],
      iconAnchor:   [16, 16],
      popupAnchor:  [0, -16]
    });

    // --- Selector de vuelos en el header ---
    const flightSelect = document.getElementById('flight-select');

    // --- Funci√≥n para convertir GeoJSON LineString a array de LatLng ---
    function lineStringToLatLngs(path_geojson) {
      let line = null;
      if (!path_geojson) return [];

      // Permitimos directamente LineString o Feature con LineString
      if (path_geojson.type === 'LineString') {
        line = path_geojson;
      } else if (path_geojson.type === 'Feature' && path_geojson.geometry && path_geojson.geometry.type === 'LineString') {
        line = path_geojson.geometry;
      }

      if (!line || !Array.isArray(line.coordinates)) return [];

      return line.coordinates.map(function(coord) {
        // GeoJSON: [lon, lat]
        return [coord[1], coord[0]];
      });
    }

    // --- Animaci√≥n de dron sobre una ruta ---
    function stopAnimation() {
      if (animationIntervalId !== null) {
        clearInterval(animationIntervalId);
        animationIntervalId = null;
      }
      if (animatedMarker) {
        map.removeLayer(animatedMarker);
        animatedMarker = null;
      }
    }

        function startFlightAnimation(latlngs) {
      stopAnimation();
      if (!latlngs || latlngs.length < 2) return;

      // Creamos un marcador normal con icono de dron en el primer punto de la ruta
      animatedMarker = L.marker(latlngs[0], {
        icon: droneIcon
      }).addTo(map);

      let idx = 0;
      animationIntervalId = setInterval(function() {
        idx = (idx + 1) % latlngs.length;
        animatedMarker.setLatLng(latlngs[idx]);
      }, 700); // se mueve cada 0.7 segundos
    }


    // --- Control de capas (Fotos / Vuelos / Zonas) ---
    const overlays = {
      'Fotos': photoLayer,
      'Vuelos': flightsLayer,
      'Zonas': zonesLayer
    };
    L.control.layers(null, overlays, { collapsed: true }).addTo(map);

    // --- Control de medici√≥n de distancia ---
    let measureMode = false;
    let measurePoints = [];
    let measurePolyline = null;

    function formatDistance(meters) {
      if (meters < 1000) {
        return meters.toFixed(1) + ' m';
      }
      return (meters / 1000).toFixed(2) + ' km';
    }

    function computeTotalDistance(points) {
      if (points.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < points.length; i++) {
        total += map.distance(points[i - 1], points[i]);
      }
      return total;
    }

    const measureControl = L.control({ position: 'topleft' });
    measureControl.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'leaflet-control custom-control');
      div.innerHTML = `
        <div>
          <button id="btn-measure">Regla</button>
          <button id="btn-measure-clear" class="secondary">Limpiar</button>
        </div>
        <span id="measure-info">Distancia: 0 m</span>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    measureControl.addTo(map);

    const btnMeasure = document.getElementById('btn-measure');
    const btnMeasureClear = document.getElementById('btn-measure-clear');
    const measureInfo = document.getElementById('measure-info');

    btnMeasure.addEventListener('click', function() {
      measureMode = !measureMode;
      btnMeasure.textContent = measureMode ? 'Midiendo‚Ä¶' : 'Regla';
      btnMeasure.style.backgroundColor = measureMode ? '#fbbf24' : '#10b981';
    });

    btnMeasureClear.addEventListener('click', function() {
      measureMode = false;
      btnMeasure.textContent = 'Regla';
      btnMeasure.style.backgroundColor = '#10b981';
      measurePoints = [];
      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
        measurePolyline = null;
      }
      measureInfo.textContent = 'Distancia: 0 m';
    });

    map.on('click', function(e) {
      if (!measureMode) return;
      measurePoints.push(e.latlng);

      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
      }
      measurePolyline = L.polyline(measurePoints, {
        color: '#f97316',
        weight: 3,
        dashArray: '4,4'
      }).addTo(measureLayer);

      const d = computeTotalDistance(measurePoints);
      measureInfo.textContent = 'Distancia: ' + formatDistance(d);
    });

    // --- Cargar datos desde la API ---
    Promise.all([
      fetch('/api/photos/').then(r => r.json()),
      fetch('/api/flights/').then(r => r.json()),
      fetch('/api/zones/').then(r => r.json()),
    ]).then(([photos, flights, zones]) => {

      // 1) Poblar el selector de vuelos
      if (flightSelect) {
        flights.sort((a, b) => {
          if (a.date && b.date && a.date !== b.date) {
            return a.date < b.date ? 1 : -1;
          }
          return a.id - b.id;
        });

        flights.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.id;
          const dateText = f.date ? ` (${f.date})` : '';
          opt.textContent = `${f.name}${dateText}`;
          if (focusFlightId !== null && f.id === focusFlightId) {
            opt.selected = true;
          }
          flightSelect.appendChild(opt);
        });

        flightSelect.addEventListener('change', () => {
          const value = flightSelect.value;
          if (value === '') {
            window.location.href = '/map/';
          } else {
            window.location.href = '/map/?flight=' + encodeURIComponent(value);
          }
        });
      }

      // 2) Si hay vuelo en la URL, filtramos las fotos a solo ese vuelo
      let photosToShow = photos;
      if (focusFlightId !== null) {
        photosToShow = photos.filter(p => p.flight === focusFlightId);
      }

      // 3) Pintar fotos con icono personalizado
      photosToShow.forEach(p => {
        const lat = parseFloat(p.lat);
        const lon = parseFloat(p.lon);
        if (!isNaN(lat) && !isNaN(lon)) {
          const marker = L.marker([lat, lon], { icon: photoIcon }).addTo(photoLayer);
          const img = p.image ? `<img src="${p.image}" style="max-width:220px;display:block;margin:6px 0">` : '';
          const notes = p.notes || '';
          marker.bindPopup(`<b>Foto #${p.id}</b><br>${img}<small>${notes}</small>`);

          extendBoundsLatLon(lat, lon);

          if (focusPhotoId !== null && p.id === focusPhotoId) {
            focusMarker = marker;
          }
        }
      });

      // 4) Pintar zonas (GeoJSON) con estilos seg√∫n zone_type
      zones.forEach(z => {
        if (!z.geometry) return;

        const zoneType = (z.zone_type || '').toLowerCase();

        const styleFn = function(feature) {
          let color = '#10b981'; // verde por defecto (Permitida / Recomendada)
          if (zoneType.includes('prohib')) {
            color = '#ef4444'; // roja
          } else if (zoneType.includes('restr')) {
            color = '#f97316'; // naranja
          }
          return {
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.15
          };
        };

        const layer = L.geoJSON(z.geometry, {
          style: styleFn
        }).addTo(zonesLayer);

        layer.bindPopup(`<b>${z.name}</b><br><small>${z.zone_type}</small>`);

        try {
          const zb = layer.getBounds();
          if (zb.isValid()) {
            bounds.extend(zb);
          }

          // üî¥ Si es zona prohibida, creamos un "c√≠rculo de seguridad"
          if (zoneType.includes('prohib')) {
            const center = zb.getCenter();
            // Radio de seguridad: 500 m (puedes subir a 1000 si quieres)
            const safetyCircle = L.circle(center, {
              radius: 500,
              color: '#ef4444',
              weight: 1,
              fillColor: '#ef4444',
              fillOpacity: 0.05
            }).addTo(zonesLayer);

            safetyCircle.bindPopup(
              `<b>Zona de seguridad</b><br><small>Radio 500 m alrededor de "${z.name}"</small>`
            );
          }
        } catch (e) {}
      });


      // 5) Pintar vuelos (rutas) con colores distintos
      const palette = [
        '#2563eb', '#16a34a', '#db2777',
        '#f97316', '#7c3aed', '#059669'
      ];

      let focusedFlightLatLngs = null;

      flights.forEach((f, idx) => {
        if (!f.path_geojson) return;
        const latlngs = lineStringToLatLngs(f.path_geojson);
        if (!latlngs.length) return;

        const color = palette[idx % palette.length];
        const isFocused = (focusFlightId !== null && f.id === focusFlightId);

        const line = L.polyline(latlngs, {
          color: color,
          weight: isFocused ? 5 : 3,
          opacity: isFocused ? 0.9 : 0.6
        }).addTo(flightsLayer);

        line.bindPopup(`<b>${f.name}</b><br><small>Modelo: ${f.drone_model || '‚Äî'}</small>`);

        try {
          const lb = line.getBounds();
          if (lb.isValid()) {
            bounds.extend(lb);
          }
        } catch (e) {}

        if (isFocused) {
          focusedFlightLatLngs = latlngs;
        }
      });

      // 6) Ajustar la vista y arrancar animaci√≥n si hay vuelo seleccionado
      if (focusMarker) {
        const ll = focusMarker.getLatLng();
        map.setView(ll, 15);
        focusMarker.openPopup();
      } else if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      }

      if (focusedFlightLatLngs) {
        startFlightAnimation(focusedFlightLatLngs);
      } else {
        stopAnimation();
      }

    }).catch(err => {
      console.error('Error cargando datos GIS', err);
    });
  </script>
</body>
</html>
