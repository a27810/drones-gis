{% extends "base.html" %}
{% load static %}

{% block title %}Mapa GIS ‚Äì Drones GIS{% endblock %}

{% block extra_css %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  >

  <style>
    .map-page-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .map-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 0.6rem 1rem;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .map-toolbar-left,
    .map-toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .map-toolbar-label {
      font-size: 0.8rem;
      color: #9ca3af;
      white-space: nowrap;
    }

    #flight-select {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      max-width: 260px;
    }

    .map-toolbar a {
      text-decoration: none;
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.6);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .map-toolbar a:hover {
      background: rgba(30, 64, 175, 0.8);
      box-shadow: 0 10px 25px rgba(30, 64, 175, 0.6);
      transform: translateY(-1px);
    }

    .btn-primary-cta {
      background: linear-gradient(135deg, #22c55e, #14b8a6);
      border-color: transparent !important;
      color: #020617 !important;
      font-weight: 600;
    }

    .btn-primary-cta:hover {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.7);
    }

    /* Contenedor del mapa */
    .map-card {
      background: radial-gradient(circle at top, #0f172a 0%, #020617 60%, #000 100%);
      border-radius: 1.5rem;
      padding: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow:
        0 20px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    #map {
      width: 100%;
      height: 78vh;      /* altura fija razonable */
      min-height: 480px; /* por si la ventana es peque√±a */
      border-radius: 1.25rem;
      overflow: hidden;
    }

    /* Controles personalizados (regla de distancia) */
    .leaflet-control.custom-control {
      background: #020617;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 0.75rem;
      font-size: 0.8rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .leaflet-control.custom-control button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 4px 9px;
      margin-right: 4px;
      font-size: 0.75rem;
      background: #22c55e;
      color: #020617;
      font-weight: 500;
    }

    .leaflet-control.custom-control button.secondary {
      background: #111827;
      color: #e5e7eb;
    }

    .leaflet-control.custom-control span {
      display: inline-block;
      margin-top: 4px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="map-page-wrapper">

  <!-- Barra superior / toolbar del mapa -->
  <div class="map-toolbar">
    <div class="map-toolbar-left">
      <span class="map-toolbar-label">Vuelo:</span>
      <select id="flight-select">
        <option value="">Todos los vuelos</option>
      </select>
    </div>

    <div class="map-toolbar-right">
      <a href="{% url 'home' %}">Inicio</a>
      <a href="{% url 'photo_list' %}">Galer√≠a</a>
      <a href="{% url 'map3d_view' %}">Mapa 3D</a>
      <a href="#" id="btn-export-geojson">Exportar GeoJSON</a>
      <a href="{% url 'upload_photo' %}" class="btn-primary-cta">+ Subir foto</a>
    </div>
  </div>

  <!-- Tarjeta con el mapa -->
  <div class="map-card">
    <div id="map"></div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <!-- Plugin Leaflet.heat -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // --- Par√°metros URL (foto / vuelo) ---
    const params = new URLSearchParams(window.location.search);
    const photoIdParam  = parseInt(params.get('photo'), 10);
    const flightIdParam = parseInt(params.get('flight'), 10);

    const focusPhotoId  = Number.isInteger(photoIdParam)  ? photoIdParam  : null;
    const focusFlightId = Number.isInteger(flightIdParam) ? flightIdParam : null;

    // --- Crear mapa ---
    const map = L.map('map').setView([40.4167, -3.7033], 6); // Madrid

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // --- Grupos de capas ---
    const photoLayer   = L.layerGroup().addTo(map);
    const flightsLayer = L.layerGroup().addTo(map);
    const zonesLayer   = L.layerGroup().addTo(map);
    const measureLayer = L.layerGroup().addTo(map); // regla

    // üî• Heatmap
    const heatLayer = L.heatLayer([], {
      radius: 25,
      blur: 15,
      maxZoom: 17
    }).addTo(map);

    const bounds = L.latLngBounds([]);
    let focusMarker      = null;
    let animatedMarker   = null;
    let animationIntervalId = null;

    function extendBoundsLatLon(lat, lon) {
      try { bounds.extend([lat, lon]); } catch (e) {}
    }

    // Icono para fotos
    const photoIcon = L.icon({
      iconUrl: "{% static 'img/camera-marker.png' %}",
      iconSize:    [28, 28],
      iconAnchor:  [14, 28],
      popupAnchor: [0, -24]
    });


    const flightSelect = document.getElementById('flight-select');

    // Convierte LineString GeoJSON a array de LatLng
    function lineStringToLatLngs(path_geojson) {
      let line = null;
      if (!path_geojson) return [];

      if (path_geojson.type === 'LineString') {
        line = path_geojson;
      } else if (
        path_geojson.type === 'Feature' &&
        path_geojson.geometry &&
        path_geojson.geometry.type === 'LineString'
      ) {
        line = path_geojson.geometry;
      }

      if (!line || !Array.isArray(line.coordinates)) return [];

      return line.coordinates.map(function (coord) {
        // GeoJSON: [lon, lat]
        return [coord[1], coord[0]];
      });
    }

    // --- Animaci√≥n del dron en la ruta ---
    function stopAnimation() {
      if (animationIntervalId !== null) {
        clearInterval(animationIntervalId);
        animationIntervalId = null;
      }
      if (animatedMarker) {
        map.removeLayer(animatedMarker);
        animatedMarker = null;
      }
    }

    function startFlightAnimation(latlngs) {
      stopAnimation();
      if (!latlngs || latlngs.length < 2) return;

      animatedMarker = L.circleMarker(latlngs[0], {
        radius: 6,
        color: '#fbbf24',
        fillColor: '#f59e0b',
        fillOpacity: 1
      }).addTo(map);

      let idx = 0;
      animationIntervalId = setInterval(function () {
        idx = (idx + 1) % latlngs.length;
        animatedMarker.setLatLng(latlngs[idx]);
      }, 700);
    }

    // --- Capas (control de capas) ---
    const overlays = {
      'Fotos': photoLayer,
      'Vuelos': flightsLayer,
      'Zonas UAS ENAIRE': zonesLayer,
      'Mapa de calor (fotos)': heatLayer
    };
    L.control.layers(null, overlays, { collapsed: true }).addTo(map);

    // --- Regla de distancia ---
    let measureMode     = false;
    let measurePoints   = [];
    let measurePolyline = null;

    function formatDistance(meters) {
      if (meters < 1000) {
        return meters.toFixed(1) + ' m';
      }
      return (meters / 1000).toFixed(2) + ' km';
    }

    function computeTotalDistance(points) {
      if (points.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < points.length; i++) {
        total += map.distance(points[i - 1], points[i]);
      }
      return total;
    }

    const measureControl = L.control({ position: 'topleft' });
    measureControl.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'leaflet-control custom-control');
      div.innerHTML = `
        <div>
          <button id="btn-measure">Regla</button>
          <button id="btn-measure-clear" class="secondary">Limpiar</button>
        </div>
        <span id="measure-info">Distancia: 0 m</span>
      `;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    measureControl.addTo(map);

    const btnMeasure      = document.getElementById('btn-measure');
    const btnMeasureClear = document.getElementById('btn-measure-clear');
    const measureInfo     = document.getElementById('measure-info');

    btnMeasure.addEventListener('click', function () {
      measureMode = !measureMode;
      btnMeasure.textContent = measureMode ? 'Midiendo‚Ä¶' : 'Regla';
      btnMeasure.style.backgroundColor = measureMode ? '#fbbf24' : '#22c55e';
    });

    btnMeasureClear.addEventListener('click', function () {
      measureMode = false;
      btnMeasure.textContent = 'Regla';
      btnMeasure.style.backgroundColor = '#22c55e';
      measurePoints = [];
      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
        measurePolyline = null;
      }
      measureInfo.textContent = 'Distancia: 0 m';
    });

    map.on('click', function (e) {
      if (!measureMode) return;

      measurePoints.push(e.latlng);

      if (measurePolyline) {
        measureLayer.removeLayer(measurePolyline);
      }

      measurePolyline = L.polyline(measurePoints, {
        color: '#f97316',
        weight: 3,
        dashArray: '4,4'
      }).addTo(measureLayer);

      const d = computeTotalDistance(measurePoints);
      measureInfo.textContent = 'Distancia: ' + formatDistance(d);
    });

    // --- Cargar datos de la API ---
    Promise.all([
      fetch('/api/photos/').then(r => r.json()),
      fetch('/api/flights/').then(r => r.json()),
      fetch('/api/zones/').then(r => r.json()),
    ]).then(([photos, flights, zones]) => {

      // 1) Rellenar selector de vuelos
      if (flightSelect) {
        flights.sort((a, b) => {
          if (a.date && b.date && a.date !== b.date) {
            return a.date < b.date ? 1 : -1;
          }
          return a.id - b.id;
        });

        flights.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.id;
          const dateText = f.date ? ` (${f.date})` : '';
          opt.textContent = `${f.name}${dateText}`;
          if (focusFlightId !== null && f.id === focusFlightId) {
            opt.selected = true;
          }
          flightSelect.appendChild(opt);
        });

        flightSelect.addEventListener('change', () => {
          const value = flightSelect.value;
          if (value === '') {
            window.location.href = '/map/';
          } else {
            window.location.href = '/map/?flight=' + encodeURIComponent(value);
          }
        });
      }

      // 2) Filtrar fotos por vuelo (si viene en la URL)
      let photosToShow = photos;
      if (focusFlightId !== null) {
        photosToShow = photos.filter(p => p.flight === focusFlightId);
      }

      const heatPoints = [];

      // 3) Pintar fotos + heatmap
      photosToShow.forEach(p => {
        const lat = parseFloat(p.lat);
        const lon = parseFloat(p.lon);
        if (!isNaN(lat) && !isNaN(lon)) {
          const marker = L.marker([lat, lon], { icon: photoIcon }).addTo(photoLayer);

          const img   = p.image ? `<img src="${p.image}" style="max-width:220px;display:block;margin:6px 0">` : '';
          const notes = p.notes || '';

          marker.bindPopup(`<b>Foto #${p.id}</b><br>${img}<small>${notes}</small>`);

          extendBoundsLatLon(lat, lon);

          if (focusPhotoId !== null && p.id === focusPhotoId) {
            focusMarker = marker;
          }

          heatPoints.push([lat, lon, 0.8]);
        }
      });

      if (heatPoints.length > 0) {
        heatLayer.setLatLngs(heatPoints);
      }

      // 4) Pintar zonas UAS ENAIRE (GeoJSON)
      zones.forEach(z => {
        if (!z.geometry) return;

        const styleFn = function (feature) {
          const t = (z.zone_type || '').toLowerCase();
          let color = '#22c55e';    // verde: permitida/recomendada
          if (t.includes('prohib')) {
            color = '#ef4444';      // rojo: prohibida
          } else if (t.includes('restr')) {
            color = '#f97316';      // naranja: restringida
          }
          return {
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.15
          };
        };

        const layer = L.geoJSON(z.geometry, {
          style: styleFn
        }).addTo(zonesLayer);

        layer.bindPopup(`<b>${z.name}</b><br><small>${z.zone_type}</small>`);

        try {
          const zb = layer.getBounds();
          if (zb.isValid()) {
            bounds.extend(zb);
          }
        } catch (e) {}
      });

      // 5) Pintar rutas de vuelo
      const palette = [
        '#2563eb', '#16a34a', '#db2777',
        '#f97316', '#7c3aed', '#059669'
      ];

      let focusedFlightLatLngs = null;

      flights.forEach((f, idx) => {
        if (!f.path_geojson) return;
        const latlngs = lineStringToLatLngs(f.path_geojson);
        if (!latlngs.length) return;

        const color     = palette[idx % palette.length];
        const isFocused = (focusFlightId !== null && f.id === focusFlightId);

        const line = L.polyline(latlngs, {
          color:  color,
          weight: isFocused ? 5 : 3,
          opacity: isFocused ? 0.9 : 0.6
        }).addTo(flightsLayer);

        line.bindPopup(`<b>${f.name}</b><br><small>Modelo: ${f.drone_model || '‚Äî'}</small>`);

        try {
          const lb = line.getBounds();
          if (lb.isValid()) {
            bounds.extend(lb);
          }
        } catch (e) {}

        if (isFocused) {
          focusedFlightLatLngs = latlngs;
        }
      });

      // 6) Ajustar vista inicial + animaci√≥n
      if (focusMarker) {
        const ll = focusMarker.getLatLng();
        map.setView(ll, 15);
        focusMarker.openPopup();
      } else if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      }

      if (focusedFlightLatLngs) {
        startFlightAnimation(focusedFlightLatLngs);
      } else {
        stopAnimation();
      }

    }).catch(err => {
      console.error('Error cargando datos GIS', err);
    });

    // --- Bot√≥n Exportar GeoJSON (fotos del vuelo actual) ---
    const exportBtn = document.getElementById('btn-export-geojson');
    if (exportBtn) {
      exportBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const params = new URLSearchParams(window.location.search);
        const flightParam = params.get('flight');
        let url = '{% url "export_photos_geojson" %}';
        if (flightParam) {
          url += '?flight=' + encodeURIComponent(flightParam);
        }
        window.location.href = url;
      });
    }
  </script>
{% endblock %}
